<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>

    <title>capifony &mdash; symfony and Symfony2 deployment</title>

    <style type="text/css">
        body {
            margin-top: 1.0em;
            margin:30px 40px;
            margin-left:100px;
            margin-top:70px;
            margin-bottom:10px;
            background-color: #fff;
            font-family: Helvetica, Arial, FreeSans, san-serif;
            color: #7a7a7a;
        }
        #logo {
            float:left;
            width:220px;
            border:0px none;
        }
        #developedby {
            border:0px none;
            float:left;
            margin-left:610px;
            margin-bottom:0px;
        }
        #logo img, #developedby img {
            border:0px none;
        }
        pre {
            overflow-y:hidden;
            overflow-x:auto;
        }
        p, pre, h3, h4, ol, ul {
            width:500px;
            margin-left:220px;
            padding:10px 20px;
            border-left:1px dashed #ccc;
            margin-top:0px;
            margin-bottom:0px;
            line-height:22px;
            font-size:16px;
        }
        ol, ul {
            padding:0px;
            padding-bottom:10px;
            padding-left:40px;
        }
        p img {
            display:block;
            margin-bottom:10px;
            margin-top:10px;
        }
        pre {
            color:#000;
            font-family:Courier;
            line-height:20px;
            font-size:12px;
        }
        pre, code {
            background:#f2f2f2;
        }
        code {
            font-size:13px;
            padding:2px 3px;
            color:#000;
        }
        pre .prompt {
            color:#7a7a7a;
        }
        p.intro {
            font-style:italic;
        }
        a {
            color:#000;
            text-decoration:underline;
        }
        a:hover {
            text-decoration:none;
        }
        h2 {
            float:left;
            text-align:right;
            padding-right:20px;
            width:200px;
            font-family:georgia;
            font-size:28px;
            font-weight:normal;
            color:#000;
            margin:5px 0px;
        }
        h3 {
            font-size:22px;
            color:#000;
            padding-top:15px;
            padding-bottom:15px;
            font-weight:normal;
        }
        .step {
            margin-bottom:50px;
        }
    </style>
</head>

<body>
    <a href="http://github.com/everzet/capifony"><img style="position: absolute; top: 0; left: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png" alt="Fork me on GitHub" /></a>

    <div class="step">
        <a id="logo" href="/">
            <img src="images/logo.png" alt="capifony"/>
        </a>

        <p class="intro">
            <a href="https://github.com/capistrano/capistrano">Capistrano</a> is an open source tool for running scripts on multiple servers. It’s primary use is for easily deploying applications. While it was built specifically for deploying <a href="http://rubyonrails.org/">Rails</a> apps, it’s pretty simple to customize it to deploy other types of applications. This project is a deployment recipes collection that works with both <a href="http://www.symfony-project.org/">symfony</a> and <a href="http://symfony.com/">Symfony2</a> applications.
        </p>
    </div>

    <div class="step">
        <h2>1. Install script</h2>
        <p>
            First, install <code>capifony</code> itself with <a href="http://rubygems.org/">RubyGems</a>:
        </p>
        <pre>
<span class="prompt">$&gt;</span> gem install capifony</pre>
    </div>

    <div class="step">
        <h2>2. Setup project</h2>
        <p>Setup initial deployment configuration for your project:</p>
        <pre>
<span class="prompt">$&gt;</span> cd to/symfony1/or/Symfony2/project/path
<span class="prompt">$&gt;</span> capifony .</pre>
        <p>
            This will create a <code>Capfile</code> in your project root &amp; a <code>deploy.rb</code> config file in <code>config/</code> (for symfony1 projects) or <code>app/config/</code> (for Symfony2 projects).
        </p>
    </div>

    <div class="step">
        <h2>3. Configure</h2>
        <p>
            Fill up your <code>config/deploy.rb</code> (or <code>app/config/deploy.rb</code>) with your server connection data. But first, you must choose your deployment strategy.
        </p>
        <h3>a) deployment &rarr; scm &rarr; production</h3>
        <p>
            The first strategy involves deployment to a production server via an intermediate git repository server. In this case, the production server <strong>must</strong> have access to your git repository (remote or not) and be able to issue a "pull" from it. You <strong>must</strong> have ssh access to the production server from wherever you're deploying from:
            <img src="images/strategy_a.png" alt="deployment strategy a">
        </p>
        <pre>
# deploy.rb

set   :application,   "My App"
set   :deploy_to,     "/var/www/my-app.com"
set   :domain,        "my-app.com"

set   :scm,           :gitrepoit
set   :repository,    "ssh-gitrepo-domain.com:/path/to/repo.git"

role  :web,           domain
role  :app,           domain
role  :db,            domain, :primary => true

set   :use_sudo,      false
set   :keep_releases, 3</pre>
        <p>
            In this case, on every <code>cap deploy</code>, capifony will:
        </p>
        <ol>
            <li>ssh to production (<code>my-app.com</code>)</li>
            <li>create a new release path (<code>/var/www/my-app.com/releases/...</code>)</li>
            <li>clone the latest project version from the remote git repo (<code>ssh-gitrepo-domain.com</code>)</li>
            <li>copy the source code, pulled from git, into the release path</li>
            <li>run deployment hooks (<code>cache:warmup</code>, <code>cc</code>, etc.)</li>
        </ol>


        <h3>b) deployment &rarr; production (via copy)</h3>
        <p>
            The second strategy involves deployment to a production server right from your deployment machine via a copy. In this case, the deployment server (which may just be your local computer) <strong>must</strong> have access to the git repository (remote or not) and be able to pull from it. The deployment server <strong>must</strong> also have ssh access to the production server:
            <img src="images/strategy_b.png" alt="deployment strategy a">
        </p>
        <pre>
# deploy.rb

set   :application,   "My App"
set   :deploy_to,     "/var/www/my-app.com"
set   :domain,        "my-app.com"

set   :scm,           :git
set   :repository,    "file:///Users/deployer/sites/my-app"
set   :deploy_via,    :copy

role  :web,           domain
role  :app,           domain
role  :db,            domain, :primary => true

set   :use_sudo,      false
set   :keep_releases, 3</pre>
        <p>
            In this case, on every <code>cap deploy</code>, capifony will:
        </p>
        <ol>
            <li>ssh to production (<code>my-app.com</code>)</li>
            <li>create a new release path (<code>/var/www/my-app.com/releases/...</code>)</li>
            <li>clone the latest project version from the <strong>local</strong> git repo</li>
            <li>copy the source code, pulled from git, onto the production server via wires</li>
            <li>run deployment hooks (<code>cache:warmup</code>, <code>cc</code>, etc.)</li>
        </ol>
        <p>
            Of course, copying the whole project on every deploy is very expensive and slow. Fortunately, you can optimize things with the <code>capistrano_rsync_with_remote_cache</code> gem:
        </p>
        <pre>
<span class="prompt">$&gt;</span> gem install capistrano_rsync_with_remote_cache</pre>
        <p>
            Now, change your deployment strategy in <code>deploy.rb</code>:
        </p>
        <pre>
set :deploy_via, :rsync_with_remote_cache</pre>
        <p>
            In this case, rsync will create a cache on your production server and will push <strong>only</strong> files that have changed between deploys.
        </p>
    </div>

    <div class="step">
        <h2>4. Setup server</h2>
        <p>
            Now, you can start the deployment process! To get your server setup with the file structure that Capistrano expects, you must run the following command just one time:
        </p>
        <pre>
<span class="prompt">$&gt;</span> cap deploy:setup</pre>
        <p>
            This command will create the following folder, approximate structure on your server. The exact structure will depend on if you're deploying a symfony1 or Symfony2 application:
        </p>
        <pre>
`-- /var/www/my-app.com
  |-- current → /var/www/my-app.com/releases/20100512131539
  |-- releases
    |-- 20100512131539
    |-- 20100509150741
    `-- 20100509145325
  `-- shared
    |-- log
    |-- config
      `-- databases.yml
    `-- web
      `-- uploads
        </pre>
        <p>
            The folders in the releases directory will be the actual deployed code, as timestamped directories. In a symfony1 application, for example, Capistrano symlinks your <code>log</code> &amp; <code>web/uploads</code> directories from your app to the directories in the shared folder so that it doesn’t get erased when you deploy a new version of your code.
        </p>
    </div>

    <div class="step">
        <h2>5. Deploy!</h2>
        <p>To deploy your application, simply run:</p>
        <pre>
<span class="prompt">$&gt;</span> cap deploy</pre>
        <p>Depending on your setup, you may need to ssh onto your server to setup additional, shared files after your first deployment (e.g. <code>app/config/parameters.ini</code> if you're using Symfony2 with the deployment recipe listed below).</p>
        <p>Something went wrong???</p>
        <pre>
<span class="prompt">$&gt;</span> cap deploy:rollback</pre>
    </div>

    <div class="step">
        <h2>Symfony2 Deployment</h2>
        
        <p>If you're deploying a Symfony2 application, then this section is probably for you. This section explains how to configure capifony to deploy an application that uses the <code>bin/vendors.php</code> file to manage vendor libraries and the <code>app/config/parameters.ini</code> file for server-specific configuration (like database connection information).</p>
        
        <p>First, add the following to your <code>app/config/deploy.rb</code> file so that the <code>parameters.ini</code> file is shared between all deployments:</p>
        
        <pre>
set :shared_files,      ["app/config/parameters.ini"]</pre>
        
        <p>Next, share the <code>vendor</code> directory between all deployments to make deploying faster:</p>
        
        <pre>
set :shared_children,     [app_path + "/logs", web_path + "/uploads", "vendor"]</pre>
        
        <p>Finally, each time you deploy, capistrano must run <code>php bin/vendors.php</code> so that all of the vendor libraries are updated. Add the following code to <code>deploy.rb</code> to make this happen:</p>
        
        <pre>
namespace :symfony do
  desc "Update the vendor libraries"
  task :update_vendors do
    run "cd #{latest_release} && #{php_bin} bin/vendors.php"
  end
end

before "deploy:finalize_update" do
  # share the children first (to get the vendor symlink)
  deploy.share_childs

  # update the vendors
  symfony.update_vendors
end</pre>
        
        <p>Now, each time you deploy, the vendors will be fully updated.</p>
        
        <p>The final step is to configure your <code>app/config/parameters.ini</code> file. The best way to do this is to start by deploying once:</p>
        
        <pre>
cap deploy</pre>
        
        <p>If you receive any errors, don't worry - Symfony isn't happy that your <code>parameters.ini</code> file isn't configured yet. Now, ssh onto your server and customize your <code>app/config/parameters.ini</code> file:</p>
        
        <pre>
ssh myuser@my-app.com
        
cd /var/www/my-app.com/shared/app/config
vim parameters.ini</pre>
        
        <p>Once your <code>parameters.ini</code> file is correctly configured, you should be able to test your deployed application. On every subsequent deploy, that same <code>app/config/parameters.ini</code> file will by symlinked into your application, meaning you only need to configure after the initial deploy.
    </div>
    
    <div class="step">
        <h2>Configuration Reference</h2>
        
            <p>Capifony is highly configurable, and any option that exists for capistrano also exists for capifony</p>

            <p>
                By default, capifony will ssh with your current system user, but you can change this behavior with <code>set :user</code> parameter:
            </p>
            <pre>
set :user, "deployer"</pre>
            <p>
                If you’re using your own private keys for git, you might want to tell Capistrano to use agent forwarding (which means that the production server uses your local keys to pull from git):
            </p>
            <pre>
ssh_options[:forward_agent] = true</pre>
            <p>
                You can also tell cap the exact branch to pull from during deployment:
            </p>
            <pre>
set :branch, "v0.2.0"</pre>
            <p>
                If you’re using git submodules, you must tell cap to fetch them:
            </p>
            <pre>
set :git_enable_submodules, 1</pre>
            <p>
                If you connect to your production server using a non-traditional port, set the port manually:
            </p>
            <pre>
ssh_options[:port] = "22123"</pre>
            <p></p>


            <h3>symfony configuration parameters</h3>
            <p>
                All symfony tasks (both <strong>symfony 1.4</strong> and <strong>Symfony2</strong>) run using the default <code>php</code> binary on the production server. You can change this via:
            </p>
            <pre>
set :php_bin, "/path/to/php"</pre>
            <p>
                All symfony tasks (both <strong>symfony 1.4</strong> and <strong>Symfony2</strong>) also run inside the <code>prod</code> environment on production server. You can change this via:
            </p>
            <pre>
set :symfony_env_prod, "staging"</pre>
            <p>
                By default, capifony will try to configure your <code>config/databases.yml</code> on every <strong>symfony 1.4</strong> project deployment (if it's not present) on production. You can turn this behavior off with:
            </p>
            <pre>
set :use_orm, false</pre>
            <p>
                If you want to use a shared symfony library instead of one bundled inside a <strong>symfony 1.4</strong> project, define the path to it with:
            </p>
            <pre>
set :symfony_lib, "/path/to/symfony"</pre>
            <p>
                If your <code>app</code> or <code>web</code> paths in <strong>Symfony2</strong> differ from default the default paths, you can specify them with:
            </p>
            <pre>
set :app_path, "my_app"
set :web_path, "my_web"</pre>
            <p>
                If you use <strong>AsseticBundle</strong> with <strong>Symfony2</strong>, then you probably want to dump assets on every deploy. Turn the next option off to *disable* the automatic dumping of assetic assets on every deploy:
            </p>
            <pre>
set :dump_assetic_assets, true</pre>

    </div>




    <a id="developedby" href="http://www.knplabs.com/en">
        <img src="images/developedby.png" alt="knpLabs product"/>
    </a>

    <div style="clear:both"></div>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7062980-15']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
